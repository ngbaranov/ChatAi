<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>–ß–∞—Ç —Å GPT</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 40px;
        }

        #chat {
            max-width: 600px;
            margin: auto;
        }

        .msg {
            margin: 5px 0;
            padding: 8px;
            border-radius: 6px;
        }

        .user {
            background: #def;
            text-align: right;
        }

        .bot {
            background: #eee;
            text-align: left;
        }
    </style>
</head>
<body>
<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∞ "–ù–æ–≤—ã–π —á–∞—Ç" -->
<div style="max-width: 600px; margin: auto; display: flex; justify-content: space-between; align-items: center;">
    <h2>–ß–∞—Ç —Å GPT</h2>
    <button id="new-chat-btn">üÜï –ù–æ–≤—ã–π —á–∞—Ç</button>
</div>

<!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
<div id="chat"></div>

<!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ -->
<div style="display: flex; gap: 8px; max-width: 600px; margin: 20px auto; align-items: center;">
    <input
            id="input"
            type="text"
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é"
            style="flex: 1; padding: 10px;"
    />
    <label style="cursor: pointer; font-size: 20px;">
        üìé
        <input id="file-input" type="file" style="display: none;"/>
    </label>
</div>

<hr style="max-width: 600px; margin: 20px auto;"/>

<!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
<div style="max-width: 600px; margin: auto;">
    <label for="provider">–ü—Ä–æ–≤–∞–π–¥–µ—Ä:</label>
    <select id="provider" onchange="updateModelOptions()" style="width: 100%;">
        <option value="openai">OpenAI</option>
        <option value="deepseek">DeepSeek</option>
    </select><br/>

    <label for="model">–ú–æ–¥–µ–ª—å:</label>
    <select id="model" style="width: 100%;"></select><br/>

    <label>System Prompt:
        <input type="text" id="prompt" style="width: 100%;"/>
    </label><br/>

    <label>Temperature:
        <input type="number" id="temperature" step="0.1" min="0" max="2" style="width: 100%;"/>
    </label><br/>

    <label>Frequency Penalty:
        <input type="number" id="freq_penalty" step="0.1" min="0" max="2" style="width: 100%;"/>
    </label><br/>

    <label>Presence Penalty:
        <input type="number" id="pres_penalty" step="0.1" min="0" max="2" style="width: 100%;"/>
    </label><br/>

    <button onclick="updateConfig()" style="margin-top: 10px;">–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

<script>
    // UI —ç–ª–µ–º–µ–Ω—Ç—ã
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const fileInput = document.getElementById("file-input");
    const newChatBtn = document.getElementById("new-chat-btn");

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
    async function refreshAccessToken() {
        try {
            const res = await fetch("/auth/refresh", {method: "POST"});
            if (!res.ok) throw new Error("Refresh failed");
            console.log("Access token refreshed");
        } catch (err) {
            alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
            location.href = "/auth/login";  // –∏–ª–∏ /login
        }
    }

    // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    let socket;

    async function connectSocket() {
        await refreshAccessToken();  // —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å access_token
        socket = new WebSocket(`${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws/chat`);
        socket.onmessage = e => appendMessage("ü§ñ " + e.data, "bot");
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function appendMessage(text, cls) {
        const d = document.createElement("div");
        d.className = "msg " + cls;
        d.textContent = text;
        chat.appendChild(d);
        chat.scrollTop = chat.scrollHeight;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (Enter)
    input.addEventListener("keydown", async ev => {
        if (ev.key !== "Enter" || !input.value.trim()) return;
        const text = input.value.trim();
        input.value = "";
        appendMessage("üßë " + text, "user");

        const payload = {message: text};
        if (fileInput.files.length) {
            const reader = new FileReader();
            reader.onload = () => {
                payload.file = reader.result.split(",")[1];
                socket.send(JSON.stringify(payload));
                fileInput.value = "";
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            socket.send(JSON.stringify(payload));
        }
    });

    // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤—ã–π —á–∞—Ç"
    newChatBtn.addEventListener("click", async () => {
        // –æ—á–∏—â–∞–µ–º UI
        chat.innerHTML = "";
        // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        const res = await fetch("/reset_chat", {method: "POST"});
        const data = await res.json();
        appendMessage("‚ú® " + data.message, "bot");
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–µ–π
    const modelOptions = {
        openai: ["gpt-4.1", "gpt-4.1-mini", "gpt-4.1-nano"],
        deepseek: ["deepseek-chat"]
    };

    function updateModelOptions() {
        const prov = document.getElementById("provider").value;
        const sel = document.getElementById("model");
        sel.innerHTML = "";
        modelOptions[prov].forEach(m => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            sel.appendChild(opt);
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ Redis
    async function loadConfig() {
        const res = await fetch("/config/get_config");
        const cfg = await res.json();
        const prov = cfg.model.startsWith("deepseek") ? "deepseek" : "openai";
        document.getElementById("provider").value = prov;
        updateModelOptions();
        document.getElementById("model").value = cfg.model;
        document.getElementById("prompt").value = cfg.prompt;
        document.getElementById("temperature").value = cfg.temperature;
        document.getElementById("freq_penalty").value = cfg.frequency_penalty;
        document.getElementById("pres_penalty").value = cfg.presence_penalty;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function updateConfig() {
        const config = {
            prompt: document.getElementById("prompt").value,
            model: document.getElementById("model").value,
            temperature: parseFloat(document.getElementById("temperature").value),
            frequency_penalty: parseFloat(document.getElementById("freq_penalty").value),
            presence_penalty: parseFloat(document.getElementById("pres_penalty").value)
        };
        fetch("/config/set_config", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(config)
        })
            .then(r => r.json())
            .then(d => alert(d.message));
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = () => {
        loadConfig();
        connectSocket();
    };
</script>
</body>
</html>
