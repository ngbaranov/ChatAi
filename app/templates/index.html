<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç —Å GPT</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 40px;
        }

        #chat {
            max-width: 600px;
            margin: auto;
        }

        .msg {
            margin: 5px 0;
            padding: 8px;
            border-radius: 6px;
        }

        .user {
            background: #def;
            text-align: right;
        }

        .bot {
            background: #eee;
            text-align: left;
        }
    </style>
</head>
<body>
<div id="chat"></div>
<input id="input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width: 100%; padding: 10px;"/>

<hr>
<h3>üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h3>
<form id="upload-form" enctype="multipart/form-data">
    <input type="file" id="file" name="file"/>
    <button type="submit">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª</button>
</form>
<pre id="file-result" style="white-space: pre-wrap; background: #f0f0f0; padding: 10px;"></pre>

<div style="max-width: 600px; margin: auto;">
    <label for="provider">–ü—Ä–æ–≤–∞–π–¥–µ—Ä:</label>
    <select id="provider" onchange="updateModelOptions()" style="width:100%">
        <option value="openai">OpenAI</option>
        <option value="deepseek">DeepSeek</option>
    </select><br>

    <label for="model">–ú–æ–¥–µ–ª—å:</label>
    <select id="model" style="width:100%"></select><br>

    <label>System Prompt: <input type="text" id="prompt" value="–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫."
                                 style="width:100%"></label><br>
    <label>Temperature: <input type="number" id="temperature" step="0.1" value="0.2" min="0" max="2"></label><br>
    <label>Frequency Penalty: <input type="number" id="freq_penalty" step="0.1" value="0.1" min="0" max="2"></label><br>
    <label>Presence Penalty: <input type="number" id="pres_penalty" step="0.1" value="0.2" min="0" max="2"></label><br>
    <button onclick="updateConfig()">–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

<script>
    const socket = new WebSocket("ws://" + location.host + "/ws/chat");
    const input = document.getElementById("input");
    const chat = document.getElementById("chat");

    function appendMessage(text, cls) {
        const div = document.createElement("div");
        div.className = "msg " + cls;
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    socket.onmessage = event => {
        appendMessage("ü§ñ " + event.data, "bot");
    };

    input.addEventListener("keydown", event => {
        if (event.key === "Enter" && input.value.trim()) {
            const message = input.value.trim();
            appendMessage("üßë " + message, "user");
            socket.send(JSON.stringify({message: message}));
            input.value = "";
        }
    });

    function updateConfig() {
        const config = {
            prompt: document.getElementById("prompt").value,
            model: document.getElementById("model").value,
            temperature: parseFloat(document.getElementById("temperature").value),
            frequency_penalty: parseFloat(document.getElementById("freq_penalty").value),
            presence_penalty: parseFloat(document.getElementById("pres_penalty").value)
        };

        fetch("/config/set_config", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(config)
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
        });
    }

    const modelOptions = {
        openai: ["gpt-4.1", "gpt-4.1-mini", "gpt-4.1-nano"],
        deepseek: ["deepseek-chat"]
    };

    function updateModelOptions() {
        const provider = document.getElementById("provider").value;
        const modelSelect = document.getElementById("model");
        modelSelect.innerHTML = "";
        modelOptions[provider].forEach(model => {
            const option = document.createElement("option");
            option.value = model;
            option.textContent = model;
            modelSelect.appendChild(option);
        });
    }

    async function loadConfig() {
        const res = await fetch("/config/get_config");
        const config = await res.json();

        const provider = config.model.startsWith("deepseek") ? "deepseek" : "openai";
        document.getElementById("provider").value = provider;

        updateModelOptions();
        document.getElementById("model").value = config.model;
        document.getElementById("prompt").value = config.prompt;
        document.getElementById("temperature").value = config.temperature;
        document.getElementById("freq_penalty").value = config.frequency_penalty;
        document.getElementById("pres_penalty").value = config.presence_penalty;
    }

    window.onload = () => {
        loadConfig();
    };

    document.getElementById("upload-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append("file", document.getElementById("file").files[0]);

        const response = await fetch("/analyze_file", {
            method: "POST",
            body: formData
        });

        const text = await response.text();
        document.getElementById("file-result").textContent = "ü§ñ –û—Ç–≤–µ—Ç:\n\n" + text;
    });
</script>

</body>
</html>
