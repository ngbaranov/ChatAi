<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ß–∞—Ç —Å GPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .msg {
      padding: 0.75rem;
      border-radius: 1rem;
      margin-bottom: 0.5rem;
      max-width: 85%;
      word-break: break-word;
    }
    .user {
      background-color: #cce5ff;
      align-self: end;
      text-align: right;
    }
    .bot {
      background-color: #f1f1f1;
      align-self: start;
      text-align: left;
    }
    #chat {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      overflow-y: auto;
    }

    @media (min-width: 992px) {
      .desktop-layout {
        display: flex;
        gap: 2rem;
      }
      #settings {
        flex: 0 0 300px;
        max-width: 300px;
        order: -1;
      }
    }

    @media (max-width: 991.98px) {
      #settings {
        order: 2;
        margin-top: 1rem;
      }
    }
  </style>
</head>
<body class="bg-light">
  <header class="container d-flex justify-content-between align-items-center py-3">
    <h2 class="m-0">–ß–∞—Ç —Å GPT</h2>
    <button id="new-chat-btn" class="btn btn-primary">üÜï –ù–æ–≤—ã–π —á–∞—Ç</button>
  </header>

  <main class="container desktop-layout">
    <div id="chat-container" class="flex-grow-1">
      <div id="chat" class="my-3"></div>

      <div class="input-group mb-2">
        <input id="input" type="text" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é">
        <button id="send-btn" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <label class="input-group-text" for="file-input">üìé</label>
        <input id="file-input" type="file" multiple style="display: none">
      </div>

      <div id="file-list" class="text-muted small mb-3"></div>
    </div>

    <div id="settings" class="mb-4">
      <div class="mb-3">
        <label for="provider" class="form-label">–ü—Ä–æ–≤–∞–π–¥–µ—Ä:</label>
        <select id="provider" class="form-select" onchange="updateModelOptions()">
          <option value="openai">OpenAI</option>
          <option value="deepseek">DeepSeek</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="model" class="form-label">–ú–æ–¥–µ–ª—å:</label>
        <select id="model" class="form-select"></select>
      </div>
      <div class="mb-3">
        <label class="form-label">System Prompt:
          <input type="text" id="prompt" class="form-control">
        </label>
      </div>
      <div class="mb-3">
        <label class="form-label">Temperature:
          <input type="number" id="temperature" step="0.1" min="0" max="2" class="form-control">
        </label>
      </div>
      <div class="mb-3">
        <label class="form-label">Frequency Penalty:
          <input type="number" id="freq_penalty" step="0.1" min="0" max="2" class="form-control">
        </label>
      </div>
      <div class="mb-3">
        <label class="form-label">Presence Penalty:
          <input type="number" id="pres_penalty" step="0.1" min="0" max="2" class="form-control">
        </label>
      </div>
      <button onclick="updateConfig()" class="btn btn-success w-100">–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
  </main>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const fileInput = document.getElementById("file-input");
    const fileList = document.getElementById("file-list");
    const newChatBtn = document.getElementById("new-chat-btn");
    const sendBtn = document.getElementById("send-btn");

    let selectedFiles = [];
    let socket;
    const modelOptions = { openai: ["gpt-4.1", "gpt-4.1-mini", "gpt-4.1-nano"], deepseek: ["deepseek-chat"] };

    function updateModelOptions() {
      const prov = document.getElementById("provider").value;
      const sel = document.getElementById("model");
      sel.innerHTML = "";
      modelOptions[prov].forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
      });
    }

    async function loadConfig() {
      const res = await fetch("/config/get_config");
      const cfg = await res.json();
      const prov = cfg.model.startsWith("deepseek") ? "deepseek" : "openai";
      document.getElementById("provider").value = prov;
      updateModelOptions();
      document.getElementById("model").value = cfg.model;
      document.getElementById("prompt").value = cfg.prompt;
      document.getElementById("temperature").value = cfg.temperature;
      document.getElementById("freq_penalty").value = cfg.frequency_penalty;
      document.getElementById("pres_penalty").value = cfg.presence_penalty;
    }

    function updateConfig() {
      const config = {
        prompt: document.getElementById("prompt").value,
        model: document.getElementById("model").value,
        temperature: parseFloat(document.getElementById("temperature").value),
        frequency_penalty: parseFloat(document.getElementById("freq_penalty").value),
        presence_penalty: parseFloat(document.getElementById("pres_penalty").value)
      };
      fetch("/config/set_config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(config)
      }).then(r => r.json()).then(d => alert(d.message));
    }

    async function refreshAccessToken() {
      try {
        const res = await fetch("/auth/refresh", { method: "POST" });
        if (!res.ok) throw 0;
      } catch {
        alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
        location.href = "/auth/login";
      }
    }

    async function connectSocket() {
      await refreshAccessToken();
      socket = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/chat`);
      socket.onmessage = e => {
        let parsed;
        try {
          parsed = JSON.parse(e.data);
        } catch {
          appendMessageHtml(marked.parse(e.data), "bot");
          return;
        }
        const { role, content } = parsed;
        const html = marked.parse(content);
        if (role === "user") {
          appendMessage("üßë " + content, "user");
        } else {
          appendMessageHtml("ü§ñ " + html, "bot");
        }
      };
    }

    function appendMessage(text, cls) {
      const d = document.createElement("div");
      d.className = "msg " + cls;
      d.innerText = text;
      chat.appendChild(d);
      d.scrollIntoView();
    }

    function appendMessageHtml(html, cls) {
      const d = document.createElement("div");
      d.className = "msg " + cls;
      d.innerHTML = html;
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }

    function updateFileListUI() {
      fileList.innerHTML = selectedFiles.length ?
        "–í—ã–±—Ä–∞–Ω—ã —Ñ–∞–π–ª—ã:<br>" + selectedFiles.map(f => `‚Ä¢ ${f.name}`).join("<br>") :
        "";
    }

    async function sendMessage() {
      if (!input.value.trim()) return;
      const text = input.value.trim();
      input.value = "";
      const payload = { message: text };
      if (selectedFiles.length) {
        payload.files = await Promise.all(selectedFiles.map(file => new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result.split(",")[1]);
          reader.onerror = rej;
          reader.readAsDataURL(file);
        })));
      }
      socket.send(JSON.stringify(payload));
      selectedFiles = [];
      updateFileListUI();
    }

    input.addEventListener("keydown", async ev => {
      if (ev.key === "Enter") {
        await sendMessage();
      }
    });

    sendBtn.addEventListener("click", sendMessage);

    fileInput.addEventListener("change", () => {
      for (const file of fileInput.files) {
        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) selectedFiles.push(file);
      }
      updateFileListUI();
      fileInput.value = "";
    });

    newChatBtn.addEventListener("click", async () => {
      chat.innerHTML = "";
      const r = await fetch("/reset_chat", { method: "POST" });
      const d = await r.json();
      appendMessage("‚ú® " + d.message, "bot");
    });

    window.onload = async () => {
      await refreshAccessToken();
      await loadConfig();
      await connectSocket();
    };
  </script>
</body>
</html>
